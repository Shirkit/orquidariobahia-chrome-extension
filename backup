(function() {
  var port = null;
  var doingTransaction = false;
  var blocker = null;

  function displayMessageOnPage(data) {
    data.target = 'page';
    data.message = 'displayMessage';
    window.postMessage(data);
  }

  function sendPayMessage(amount, method) {
    var message = {};

    message.action = 'pay';
    message.amount = amount;
    message.paymentMethod = method;

    return sendMessage(message);
  }

  function sendMessage(message) {
    if (port != null) {
      port.postMessage(message);
      return true;
    } else {
      return false;
    }
  }

  function onMessage(message) {
    if (message === null) {
      console.log('null message received');

    } else if (message.response === 'connect_busy') {
      displayMessageOnPage({
        content: message.message,
        level: 'error',
        permanent: true
      });

    } else if (message.response === 'connect_ok') {
      displayMessageOnPage({
        content: message.message,
        level: 'info'
      });

    } else if (message.response === 'connect_error') {
      displayMessageOnPage({
        content: message.message,
        level: 'error',
        permanent: true
      });

    } else if (message.response === 'pay_ok') {
      doingTransaction = false;
      blocker.unblock();
      displayMessageOnPage({
        content: message.message,
        level: 'sucess'
      });

    } else if (message.response === 'pay_tryagain') {
      doingTransaction = false;
      blocker.unblock();
      displayMessageOnPage({
        content: message.message,
        level: 'warning',
        permanent: true
      });

    } else if (message.response === 'pay_error') {
      doingTransaction = false;
      blocker.unblock();
      displayMessageOnPage({
        content: message.message,
        level: 'error',
        permanent: true
      });

    } else if (message.response === 'pay_fatal') {
      doingTransaction = false;
      blocker.unblock();
      displayMessageOnPage({
        content: message.message,
        level: 'error',
        permanent: true
      });

    } else if (message.response === 'unkown_error') {
      displayMessageOnPage({
        content: message.message,
        level: 'error',
        permanent: true
      });

    } else {
      console.log('unkown message received');
      console.log(message);
    }
  }

  function onDisconnect() {
    console.log('Disconnected');
  }

  function connectToTerminal() {
    if (port == null) {
      port = chrome.runtime.connect();
      port.onDisconnect.addListener(onDisconnect);
      port.onMessage.addListener(onMessage);
    }
  }

  window.addEventListener('message', function(evt) {
    if (evt.source != window)
      return;

    if (evt.data.target == 'content') {
      switch (evt.data.message) {
        case 'connectToTerminal':
          connectToTerminal();
          break;
        case 'pay':
          doingTransaction = true;
          sendPayMessage(evt.data.amount, evt.data.method);
          blocker = jQuery('#modal-order_payment');
          blocker.data('blockUI.onUnblock', function(e) {
            if (doingTransaction) {
              jQuery(e).block({
                message: '<div class="payment_sense_box">Terminar transação no Terminal.<button class="button" id="cancel-pos-chip-pin">Cancelar</button></div>',
                overlayCSS: {
                  background: '#fff',
                  opacity: 0.6
                }
              });
            }
          });
          break;
      }
    }
  });

  console.log('Content script loaded');
})();
